<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Crypto Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'crypto-blue': '#1e3a8a',
                        'crypto-green': '#059669',
                        'crypto-orange': '#ea580c',
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-crypto-blue rounded-lg flex items-center justify-center">
                        <i class="fas fa-coins text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">Crypto Checkout</h1>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fas fa-shield-alt text-crypto-green mr-1"></i>
                    Secure Payment
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Invoice Details -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">{{.Title}}</h2>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-clock mr-1"></i>
                                Pending Payment
                            </span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-1">Invoice ID</p>
                        <p class="font-mono text-gray-900">{{.Invoice.ID}}</p>
                    </div>

                    <!-- Items Table -->
                    <div class="border rounded-lg overflow-hidden mb-6">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {{range .Invoice.Items}}
                                <tr>
                                    <td class="px-4 py-4">
                                        <div>
                                            <p class="font-medium text-gray-900">{{.Description}}</p>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-right text-gray-900">{{.Quantity}}</td>
                                    <td class="px-4 py-4 text-right text-gray-900">${{.UnitPrice.String}}</td>
                                    <td class="px-4 py-4 text-right font-medium text-gray-900">${{.TotalPrice.String}}</td>
                                </tr>
                                {{end}}
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="3" class="px-4 py-3 text-right text-sm font-medium text-gray-900">Subtotal:</td>
                                    <td class="px-4 py-3 text-right font-medium text-gray-900">${{.Invoice.Pricing.Subtotal.String}}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="px-4 py-3 text-right text-sm font-medium text-gray-900">Tax:</td>
                                    <td class="px-4 py-3 text-right font-medium text-gray-900">${{.Invoice.Pricing.Tax.String}}</td>
                                </tr>
                                <tr class="border-t-2 border-gray-200">
                                    <td colspan="3" class="px-4 py-3 text-right text-lg font-bold text-gray-900">Total:</td>
                                    <td class="px-4 py-3 text-right text-lg font-bold text-gray-900">${{.Invoice.Pricing.Total.String}}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Expiry Timer -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-hourglass-half text-crypto-orange mr-2"></i>
                            <span class="text-sm font-medium text-orange-800">Invoice expires in</span>
                            <span id="timer" class="ml-2 font-mono text-orange-900 font-bold">24:37</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border p-6 sticky top-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-wallet text-crypto-blue mr-2"></i>
                        Payment Details
                    </h3>

                    <!-- Amount to Pay -->
                    <div class="text-center mb-6">
                        <p class="text-sm text-gray-600 mb-1">Amount to Pay</p>
                        <div class="text-3xl font-bold text-crypto-blue mb-1">{{.TotalAmount}} USDT</div>
                        <p class="text-sm text-gray-500">TRC-20 (Tron Network)</p>
                    </div>

                    <!-- QR Code -->
                    <div class="text-center mb-6">
                        <div class="inline-block p-4 bg-white border-2 border-gray-200 rounded-lg">
                            <div class="w-48 h-48 bg-gray-100 flex items-center justify-center">
                                {{if .QRCodeURL}}
                                <img src="{{.QRCodeURL}}" alt="Payment QR Code" class="w-full h-full object-contain">
                                {{else}}
                                <!-- QR Code placeholder -->
                                <div class="text-center">
                                    <i class="fas fa-qrcode text-6xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">QR Code Loading...</p>
                                </div>
                                {{end}}
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Scan with your crypto wallet</p>
                    </div>

                    <!-- Payment Address -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Address</label>
                        <div class="flex rounded-md shadow-sm">
                            <input 
                                id="payment-address" 
                                type="text" 
                                value="{{if .PaymentAddress}}{{.PaymentAddress.String}}{{else}}No address assigned{{end}}" 
                                readonly
                                class="flex-1 min-w-0 px-3 py-2.5 border border-gray-300 rounded-none rounded-l-md text-sm font-mono bg-gray-50 text-gray-900 focus:outline-none focus:ring-1 focus:ring-crypto-blue focus:border-crypto-blue"
                            >
                            <button 
                                onclick="copyAddress()" 
                                class="inline-flex items-center px-4 py-2.5 border border-l-0 border-gray-300 bg-crypto-blue text-white text-sm font-medium rounded-r-md hover:bg-blue-700 focus:outline-none focus:ring-1 focus:ring-crypto-blue transition-colors"
                            >
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Amount Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Exact Amount</label>
                        <div class="flex rounded-md shadow-sm">
                            <input 
                                id="payment-amount" 
                                type="text" 
                                value="{{.TotalAmount}}" 
                                readonly
                                class="flex-1 min-w-0 px-3 py-2.5 border border-gray-300 rounded-none rounded-l-md text-sm font-mono bg-gray-50 text-gray-900 focus:outline-none focus:ring-1 focus:ring-crypto-green focus:border-crypto-green"
                            >
                            <button 
                                onclick="copyAmount()" 
                                class="inline-flex items-center px-4 py-2.5 border border-l-0 border-gray-300 bg-crypto-green text-white text-sm font-medium rounded-r-md hover:bg-green-700 focus:outline-none focus:ring-1 focus:ring-crypto-green transition-colors"
                            >
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Send exactly this amount</p>
                    </div>

                    <!-- Payment Instructions -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h4 class="font-medium text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Payment Instructions
                        </h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>• Send <strong>exactly {{.TotalAmount}} USDT</strong></li>
                            <li>• Use <strong>TRC-20</strong> network only</li>
                            <li>• Payment confirms in 1-3 minutes</li>
                            <li>• Don't send from exchanges</li>
                        </ul>
                    </div>

                    <!-- Status Updates -->
                    <div id="status-updates" class="text-center">
                        <div class="flex items-center justify-center space-x-2 text-sm text-gray-600">
                            <div class="animate-spin w-4 h-4 border-2 border-gray-300 border-t-crypto-blue rounded-full"></div>
                            <span>Waiting for payment...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between text-sm text-gray-500">
                <div class="flex items-center space-x-4">
                    <span>Powered by Crypto Checkout</span>
                    <span>•</span>
                    <a href="#" class="hover:text-gray-700">Support</a>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-lock text-crypto-green"></i>
                    <span>Secure & Anonymous</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Copy address function
        function copyAddress() {
            const address = document.getElementById('payment-address');
            address.select();
            navigator.clipboard.writeText(address.value);
            showCopySuccess('Address copied!');
        }

        // Copy amount function  
        function copyAmount() {
            const amount = document.getElementById('payment-amount');
            amount.select();
            navigator.clipboard.writeText(amount.value);
            showCopySuccess('Amount copied!');
        }

        // Show copy success message
        function showCopySuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-crypto-green text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity';
            toast.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Timer countdown
        let timeLeft = 25 * 60 + 37; // 25:37 in seconds
        const timerElement = document.getElementById('timer');

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                timerElement.textContent = "EXPIRED";
                timerElement.className += " text-red-600";
                return;
            }
            
            timeLeft--;
        }

        // Update timer every second
        setInterval(updateTimer, 1000);

        // Payment tracking
        let totalReceived = 0;
        const totalRequired = 16.49;
        const payments = [];

        // Add payment to history
        function addPayment(amount, txHash, status) {
            const payment = {
                id: `pay_${Date.now()}`,
                amount: amount,
                txHash: txHash,
                status: status,
                timestamp: new Date()
            };
            
            payments.push(payment);
            updatePaymentDisplay();
            updateProgress();
        }

        // Update payment display
        function updatePaymentDisplay() {
            const paymentList = document.getElementById('payment-list');
            
            if (payments.length === 0) {
                paymentList.innerHTML = `
                    <div class="text-center py-4 text-gray-500 text-sm">
                        <i class="fas fa-clock text-2xl mb-2"></i>
                        <p>No payments received yet</p>
                    </div>
                `;
                return;
            }

            paymentList.innerHTML = payments.map(payment => `
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-mono text-sm font-medium">${payment.amount} USDT</span>
                            ${getStatusBadge(payment.status)}
                        </div>
                        <span class="text-xs text-gray-500">${formatTime(payment.timestamp)}</span>
                    </div>
                    <div class="flex items-center space-x-2 text-xs text-gray-600">
                        <i class="fas fa-link"></i>
                        <span class="font-mono truncate">${payment.txHash}</span>
                        <button onclick="copyTxHash('${payment.txHash}')" class="text-crypto-blue hover:text-blue-700">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'detected': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-eye mr-1"></i>Detected</span>',
                'confirming': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><i class="fas fa-clock mr-1"></i>Confirming</span>',
                'confirmed': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>Confirmed</span>',
                'failed': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-times mr-1"></i>Failed</span>'
            };
            return badges[status] || badges['detected'];
        }

        // Format timestamp
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Update progress bar
        function updateProgress() {
            const confirmedAmount = payments
                .filter(p => p.status === 'confirmed')
                .reduce((sum, p) => sum + p.amount, 0);
            
            const progressPercent = Math.min((confirmedAmount / totalRequired) * 100, 100);
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            
            // Update progress text
            const progressText = document.querySelector('.flex.justify-between.items-center.mb-2 .text-sm.text-gray-500');
            progressText.textContent = `${confirmedAmount.toFixed(2)} / ${totalRequired} USDT`;
        }

        // Copy transaction hash
        function copyTxHash(txHash) {
            navigator.clipboard.writeText(txHash);
            showCopySuccess('Transaction hash copied!');
        }

        // Simulate payment updates with multiple payments
        function simulatePaymentUpdate() {
            // First partial payment
            setTimeout(() => {
                addPayment(10.00, 'a7b2c3d4e5f6789012345678901234567890abcdef', 'detected');
                document.getElementById('status-updates').innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-sm text-orange-600">
                        <div class="w-4 h-4 bg-orange-500 rounded-full animate-pulse"></div>
                        <span>Partial payment detected!</span>
                    </div>
                `;
            }, 15000);

            // Confirm first payment
            setTimeout(() => {
                payments[0].status = 'confirmed';
                updatePaymentDisplay();
                updateProgress();
                
                document.getElementById('status-updates').innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-sm text-blue-600">
                        <div class="animate-spin w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full"></div>
                        <span>Waiting for remaining payment...</span>
                    </div>
                `;
            }, 25000);

            // Second payment (completing the invoice)
            setTimeout(() => {
                addPayment(6.49, 'b8c3d4e5f6789012345678901234567890abcdef1', 'detected');
                document.getElementById('status-updates').innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-sm text-orange-600">
                        <div class="w-4 h-4 bg-orange-500 rounded-full animate-pulse"></div>
                        <span>Final payment detected! Confirming...</span>
                    </div>
                `;
            }, 40000);

            // Confirm final payment
            setTimeout(() => {
                payments[1].status = 'confirmed';
                updatePaymentDisplay();
                updateProgress();
                
                document.getElementById('status-updates').innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-sm text-crypto-green">
                        <i class="fas fa-check-circle"></i>
                        <span>Payment completed! Thank you.</span>
                    </div>
                `;
            }, 50000);
        }

        // Start simulation
        simulatePaymentUpdate();
    </script>
</body>
</html>